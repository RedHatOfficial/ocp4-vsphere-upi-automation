---
- hosts: localhost
  gather_facts: True
  
  roles:
    - role: setup
    - role: cache

- hosts: localhost
  gather_facts: True
  environment:
    PATH: "{{ playbook_dir }}/bin:{{ ansible_env.PATH }}"
  tasks:
    - name: Run all the common pre-install tasks
      import_role:
        name: common
        tasks_from: pre_install

# ---------------------------------------------------------------------------------------------
- hosts: registries
  gather_facts: False
  tasks:
    - name: Run the setup tasks for a restricted environment
      import_role:
        name: restricted
        tasks_from: setup_registry
      when: registry.enabled | bool and registry.disconnected | bool

- hosts: localhost
  gather_facts: False
  tasks:
    - name: Run the tasks for a restricted environment
      import_role:
        name: restricted
        tasks_from: utilize_registry
      when: registry.enabled | bool and registry.disconnected | bool

- hosts: localhost
  gather_facts: True
  environment:
    PATH: "{{ playbook_dir }}/bin:{{ ansible_env.PATH }}"
  tasks:
    - name: Run all the common tasks
      import_role:
        name: common
        tasks_from: install
# ---------------------------------------------------------------------------------------------              
- name: Setup webserver
  hosts: webservers
  gather_facts: false

  pre_tasks:
    - name: Include vars
      ansible.builtin.include_vars:
        file: "clusters/{{ cluster }}.yaml"

  tasks:
    - name: Set required facts
      set_fact:
        download: "{{ hostvars[groups['all'].0].download }}"
        config: "{{ hostvars[groups['all'].0].config }}"
      when:
        - config is not defined
        - download is not defined
        - inventory_hostname != "localhost"

    - name: Create webserver paths for the cluster
      import_role:
        name: webserver
        tasks_from: create_cluster_dir

    - name: Copy over generated ignition files to webserver
      import_role:
        name: webserver
        tasks_from: copy_ign_files

    - name: Download the installer raw.gz file to webserver
      import_role:
        name: webserver
        tasks_from: download_raw_installer_files
# ---------------------------------------------------------------------------------------------

- name: Deploy Openshift on VmWare
  hosts: all
  environment:
    PATH: "{{ playbook_dir }}/bin:{{ ansible_env.PATH }}"
    GOVC_USERNAME: "{{ vcenter.username }}"
    GOVC_PASSWORD: "{{ vcenter.password }}"
    GOVC_URL: "https://{{ vcenter.ip }}"
    GOVC_DATACENTER: "{{ vcenter.datacenter }}"
    GOVC_INSECURE: "1"

  pre_tasks:
    - name: Include vars
      ansible.builtin.include_vars:
        file: "clusters/{{ cluster }}.yaml"

  roles:
    - role: setup
    - role: cache
    - role: common
    - role: vsphere_vm
    - role: finish_install

- name: Generate the ignition manifests
  command: "openshift-install create manifests --dir={{ playbook_dir }}/install-dir"

- name: Apply the patch to set mastersSchedulable to false
  patch:
    src: "cluster-scheduler-02-config.yml.patch"
    dest: "{{ playbook_dir }}/install-dir/manifests/cluster-scheduler-02-config.yml"

- name: Configure machineconfig files for custom ntp servers
  when: configure_ntp
  block:
  - name: Create the chrony.conf file
    template:
      src: chrony.conf.j2
      dest: /tmp/chrony.conf
  
  - name: Save base64 of config file
    set_fact:
      chrony_base64: "{{ (lookup('file', '/tmp/chrony.conf') + '\n') | b64encode }}"

  - name: Generate the machineconfigs for chrony
    template:
      src: mc-chrony-configuration.yaml.j2
      dest: "{{ playbook_dir }}/install-dir/manifests/99-{{ item }}-chrony-configuration.yaml"
    loop:
      - master
      - worker
    
- name: Generate the ignition configs
  command: "openshift-install create ignition-configs --dir={{ playbook_dir }}/install-dir"
